<!--

    Copyright (c) 2025 Oracle and/or its affiliates. All rights reserved.

    This program and the accompanying materials are made available under the
    terms of the Eclipse Public License v. 2.0 which is available at
    http://www.eclipse.org/legal/epl-2.0,
    or the Eclipse Distribution License v. 1.0 which is available at
    http://www.eclipse.org/org/documents/edl-v10.php.

    SPDX-License-Identifier: EPL-2.0 OR BSD-3-Clause

-->

<!--
  Contributors:
      Rick Curtis- initial API and implementation
-->
<project name="eclipselink.jpa.test.deadlock" default="test" basedir=".">

    <!-- Initialize environment variables first. Do not place lines above these. -->
    <property environment="env" />
    <property file="${user.home}/build.properties" />
    <property file="${test.properties}" />
    <property file="./antbuild.properties" />
    <property file="./test.properties" />

    <property name="deadlock.el.root"            value="${basedir}/../.."/>
    <property name="deadlock.jpa.root"           value="${basedir}/.."/>
    
    <property name="deadlock.src.dir"            value="${basedir}/src"/>
    <property name="deadlock.classes.dir"        value="${basedir}/classes" />
    <!-- Use common property name to allow override -->
    <property name="reports.dir"            value="${basedir}/reports" />
    <property name="deadlock.run.dir"            value="${basedir}/run" />
    
    <property name="deadlock.el.plugins.dir"     value="${deadlock.el.root}/plugins"/>
    <property name="deadlock.jpa.plugins.dir"    value="${deadlock.jpa.root}/plugins"/>
    <property name="deadlock.core.test.dir" value="${deadlock.el.root}/foundation/eclipselink.core.test"/>
    <property name="deadlock.jpa.test.dir"  value="${deadlock.jpa.root}/eclipselink.jpa.test"/>

    <property name="version.qualifier"     value="qualifier"/>
    <property name="version.string"        value="${release.version}.${version.qualifier}"/>

    <!-- Not sure if there is a better way to refer to dependencies? -->
    <property name="deadlock.eclipselink.jar" value="${deadlock.el.root}/${eclipselink.jar}"/>
    <property name="deadlock.coretest.framework.jar" value="${deadlock.core.test.dir}/${coretest.framework.jar}"/>
    <property name="deadlock.core.test.jar" value="${deadlock.core.test.dir}/${core.test.jar}"/>
    <property name="deadlock.jpatest.framework.jar" value="${deadlock.jpa.test.dir}/${jpatest.framework.jar}"/>

    <property name="javax.annotation" value="${deadlock.el.plugins.dir}/${annotation-api.jar}"/>
    <property name="javax.transaction" value="${deadlock.el.plugins.dir}/${transaction.jar}"/>
    <property name="javax.validation" value="${deadlock.el.plugins.dir}/${validation.jar}"/>
    <property name="javax.persistence" value="${deadlock.jpa.plugins.dir}/${persistence22.jar}"/>
    <property name="javax.enterprise.cdi-api" value="${deadlock.el.plugins.dir}/${cdi-api.jar}"/>
    <property name="javax.inject" value="${deadlock.el.plugins.dir}/${inject.jar}"/>
    <property name="javax.interceptor" value="${deadlock.el.plugins.dir}/${interceptor-api.jar}"/>
    <property name="javax.el.api" value="${deadlock.el.plugins.dir}/${el-api.jar}"/>
    <property name="jboss.classfilewriter" value="${deadlock.el.plugins.dir}/${jboss-classfilewriter.jar}"/>
    <property name="jboss.logging" value="${deadlock.el.plugins.dir}/${jboss-logging.jar}"/>
    <property name="jboss.weld.api" value="${deadlock.el.plugins.dir}/${jboss-weld-api.jar}"/>
    <property name="jboss.weld.spi" value="${deadlock.el.plugins.dir}/${jboss-weld-spi.jar}"/>
    <property name="jboss.weld.environment.common" value="${deadlock.el.plugins.dir}/${jboss-weld-environment-common.jar}"/>
    <property name="jboss.weld.se.core" value="${deadlock.el.plugins.dir}/${jboss-weld-se-core.jar}"/>
    <property name="jboss.weld.core.impl" value="${deadlock.el.plugins.dir}/${jboss-weld-core-impl.jar}"/>
    <fileset id="deadlock.antlr.jar.path" dir="${deadlock.el.plugins.dir}" includes="*antlr_*.jar"/>
    <pathconvert property="deadlock.antlr.jar" refid="deadlock.antlr.jar.path"/>
    <fileset id="deadlock.asm.jar.path" dir="${deadlock.el.plugins.dir}" includes="org.eclipse.persistence.asm.jar"/>
    <pathconvert property="deadlock.asm.jar" refid="deadlock.asm.jar.path"/>
    <property name="deadlock.core.jar" value="${deadlock.el.plugins.dir}/org.eclipse.persistence.core_${version.string}.jar"/>
    <property name="deadlock.jpa.jar" value="${deadlock.el.plugins.dir}/org.eclipse.persistence.jpa_${version.string}.jar"/>
    <property name="deadlock.jpql.jar" value="${deadlock.el.plugins.dir}/org.eclipse.persistence.jpa.jpql_${version.string}.jar"/>
	<property name="deadlock.modelgen.jar" value="${deadlock.el.plugins.dir}/org.eclipse.persistence.jpa.modelgen_${version.string}.jar"/>
	<property name="deadlock.dbws.jar" value="${deadlock.el.plugins.dir}/org.eclipse.persistence.dbws_${version.string}.jar"/>

    <!-- JVM used to run tests -->
    <property name="test.junit.jvm" value="${env.JAVA_HOME}"/>
    <property name="test.junit.jvm.exec" value="${test.junit.jvm}/bin/java"/>

    <path id="compile.deadlock.path">
        <pathelement path="${javax.persistence}" />
        <pathelement path="${deadlock.eclipselink.jar}" />
        <pathelement path="${deadlock.modelgen.jar}" />
        <pathelement path="${deadlock.coretest.framework.jar}" />
        <pathelement path="${deadlock.core.test.jar}" />
        <pathelement path="${deadlock.jpatest.framework.jar}" />
        <pathelement path="${javax.transaction}" />
        <pathelement path="${javax.validation}" />
        <pathelement path="${javax.inject}" />
        <pathelement path="${javax.enterprise.cdi-api}" />
        <pathelement path="${junit.lib}" />
    </path>
    <path id="run.deadlock.path">
        <pathelement path="${deadlock.classes.dir}" />
        <pathelement path="${javax.persistence}" />
        <pathelement path="${deadlock.antlr.jar}" />
        <pathelement path="${deadlock.asm.jar}" />
        <pathelement path="${deadlock.core.jar}" />
        <pathelement path="${deadlock.jpa.jar}" />
        <pathelement path="${deadlock.jpql.jar}" />
        <pathelement path="${deadlock.modelgen.jar}" />
        <pathelement path="${deadlock.dbws.jar}" />
        <pathelement path="${deadlock.coretest.framework.jar}" />
        <pathelement path="${deadlock.core.test.jar}" />
        <pathelement path="${deadlock.jpatest.framework.jar}" />
        <pathelement path="${javax.annotation}" />
        <pathelement path="${javax.transaction}" />
        <pathelement path="${javax.validation}" />
        <pathelement path="${javax.el.api}" />
        <pathelement path="${javax.enterprise.cdi-api}" />
        <pathelement path="${javax.inject}" />
        <pathelement path="${javax.interceptor}" />
        <pathelement path="${jboss.classfilewriter}" />
        <pathelement path="${jboss.weld.api}" />
        <pathelement path="${jboss.weld.spi}" />
        <pathelement path="${jboss.weld.environment.common}" />
        <pathelement path="${jboss.weld.se.core}" />
        <pathelement path="${jboss.weld.core.impl}" />
        <pathelement path="${jboss.logging}" />
        <pathelement path="${junit.lib}" />
        <pathelement path="${jdbc.driver.jar}" />
    </path>

    <pathconvert property="deadlock.compile.cp" refid="compile.deadlock.path"/>
    <pathconvert property="deadlock.run.cp" refid="run.deadlock.path"/>
    
    <echo message="deadlock.el.root                      = ${deadlock.el.root}"/>
    <echo message="deadlock.jpa.root                     = ${deadlock.jpa.root}"/>
    <echo message="deadlock.eclipselink.jar              = ${deadlock.eclipselink.jar}"/>
    <echo message="deadlock.classes.dir                  = ${deadlock.classes.dir}"/>
    <echo message="deadlock.src.dir                      = ${deadlock.src.dir}"/>
    <echo message="compile classpath                = ${deadlock.compile.cp}"/>
    <echo message="run classpath                    = ${deadlock.run.cp}"/>   
    <echo message="report dir                       = ${reports.dir}"/>
    <echo message="basedir                          = ${basedir}"/>
    <echo message="junitlib                         = ${junit.lib}"/>
    <echo message="deadlock.run.cp                       = ${deadlock.run.cp}"/>

    <target name="test-no-report" depends="test-run"/>
    <target name="test" depends="test-run, test-report"/>
    
    <target name="test-run" depends="compile, weave">
        <mkdir dir="${reports.dir}"/>
        <mkdir dir="${deadlock.run.dir}"/>
        <property name="rmi.port" value="1099"/>
        <property name="additional.jvmargs" value="-Ddummy2=dummy"/>
        <property name="debugargs" value="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=7777"/>
        <property name="rmi" value="-Djava.naming.provider.url=rmi://localhost:${rmi.port} -Djava.naming.factory.initial=com.sun.jndi.rmi.registry.RegistryContextFactory"/>
        <junit printsummary="on" haltonfailure="false" fork="yes" failureproperty="fail" logfailedtests="true">
            <jvmarg line="${additional.jvmargs} ${rmi}"/>
            <sysproperty key="additional.jvmargs" value="${additional.jvmargs}"/>
            <jvmarg value="-javaagent:${deadlock.eclipselink.jar}"/>
            <sysproperty key="javax.persistence.jdbc.url" value="${db.url}"/>
            <sysproperty key="javax.persistence.jdbc.driver" value="${db.driver}"/>
            <sysproperty key="javax.persistence.jdbc.user" value="${db.user}"/>
            <sysproperty key="javax.persistence.jdbc.password" value="${db.pwd}"/>
            <classpath>
                <path refid="run.deadlock.path" />
            </classpath>

            <formatter type="xml"/>

            <batchtest fork="no" todir="${reports.dir}">
                <fileset dir="${deadlock.src.dir}">
                    <include name="**/CacheDeadLockManagersTest*.java"/>
                </fileset>
            </batchtest>
        </junit>
        <junit printsummary="on" haltonfailure="false" fork="yes" failureproperty="fail" logfailedtests="true">
            <jvmarg line="${additional.jvmargs} ${rmi}"/>
            <sysproperty key="additional.jvmargs" value="${additional.jvmargs}"/>
            <jvmarg value="-javaagent:${deadlock.eclipselink.jar}"/>
            <sysproperty key="javax.persistence.jdbc.url" value="${db.url}"/>
            <sysproperty key="javax.persistence.jdbc.driver" value="${db.driver}"/>
            <sysproperty key="javax.persistence.jdbc.user" value="${db.user}"/>
            <sysproperty key="javax.persistence.jdbc.password" value="${db.pwd}"/>
            <sysproperty key="eclipselink.concurrency.manager.waittime" value="1"/>
            <sysproperty key="eclipselink.concurrency.manager.maxsleeptime" value="2"/>
            <sysproperty key="eclipselink.concurrency.manager.maxfrequencytodumptinymessage" value="3"/>
            <sysproperty key="eclipselink.concurrency.manager.maxfrequencytodumpmassivemessage" value="4"/>
            <sysproperty key="eclipselink.concurrency.manager.allow.readlockstacktrace" value="true"/>
            <sysproperty key="eclipselink.concurrency.manager.allow.concurrencyexception" value="true"/>
            <sysproperty key="eclipselink.concurrency.manager.allow.interruptedexception" value="true"/>
            <classpath>
                <path refid="run.deadlock.path" />
            </classpath>

            <formatter type="xml"/>

            <batchtest fork="no" todir="${reports.dir}">
                <fileset dir="${deadlock.src.dir}">
                    <include name="**/CacheDeadLockDetectionTest*.java"/>
                    <include name="**/CacheKeyNullKeyTest*.java"/>
                </fileset>
            </batchtest>
        </junit>
        <fail message="TESTS FAILED !">
            <condition>
                <and>
                    <isset property="fail"/>
                    <istrue value="${test.fail.fast}"/>
                </and>
            </condition>
        </fail>
    </target>
    
    <target name="test-report">
        <junitreport todir="./reports">
          <fileset dir="./reports">
            <include name="TEST-*.xml"/>
          </fileset>
          <report format="frames" todir="./reports/html"/>
        </junitreport>
        <echo message="JUNIT results in ${user.dir}/reports/html"/>
        <fail if="fail" message="Test failures detected, please check the results."/>
    </target>

    <!--
    Ideally we could do something smart here to have different weaving targets to weave with different properties.
    We can cross that bridge when / if it is needed.
    -->
    <target name="weave">
        <weave source="${deadlock.classes.dir}" target="${deadlock.classes.dir}" loglevel="WARNING">
            <classpath>
                <path refid="compile.deadlock.path" />
            </classpath>
        </weave>
    </target>

    <target name="compile">
        <mkdir dir="${deadlock.classes.dir}"/>
        <copy todir="${deadlock.classes.dir}/META-INF">
            <fileset dir="${deadlock.src.dir}/META-INF" includes="**/*" excludes=".git*"/>
        </copy>

        <javac debug="true" destdir="${deadlock.classes.dir}" includeantruntime="false" source="${javac.version}" target="${javac.version}">
            <compilerarg value="-proc:none"/>
            <classpath refid="compile.deadlock.path"/>
            <src path="src"/>
        </javac>
    </target>
    <target name="clean">
        <delete dir="${deadlock.classes.dir}" />
        <delete dir="${deadlock.run.dir}" />
        <delete dir="${reports.dir}" />
    </target>

    <taskdef name="weave" classname="org.eclipse.persistence.tools.weaving.jpa.StaticWeaveAntTask">
        <classpath>
            <path refid="compile.deadlock.path" />
        </classpath>
    </taskdef>
</project>
